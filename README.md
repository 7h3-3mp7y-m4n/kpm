<h1 align="center">Kpm: KCL Package Manager</h1>

<p align="center">
<a href="./README.md">English</a> | <a href="./README-zh.md">简体中文</a>
</p>
<p align="center">
<a href="#introduction">Introduction</a> | <a href="#installation">Installation</a> | <a href="#quick-start">Quick start</a> 
</p>

<p align="center">
<img src="https://coveralls.io/repos/github/KusionStack/kpm/badge.svg">
<img src="https://img.shields.io/badge/license-Apache--2.0-green">
<img src="https://img.shields.io/badge/PRs-welcome-brightgreen">
</p>

## Introduction

`kpm` is the KCL package manager. `kpm` downloads your KCL package's dependencies, compiles your KCL packages, makes packages, and uploads them to the kcl package registry.

## Installation

### Install KCL

`kpm` will call [KCL compiler](https://github.com/KusionStack/KCLVM) to compile the kcl program. Before using `kpm`, you need to ensure that `KCL compiler` is installed successfully.

[For more information about how to install KCL compiler.](https://kcl-lang.io/docs/user_docs/getting-started/install)

Use the following command to ensure that you install `KCL compiler` successfully.

```shell
kclvm_cli version
```

If the above command shows the version information of `KCL compiler` normally, it means that you have successfully installed `KCL compiler` and you can do the next step.

<img src="./docs/gifs/kclvm_cli_version.gif" width="600" align="center" />

### Install `kpm`

#### Go install

You can download `kpm` via `go install`.

```shell
go install kusionstack.io/kpm@latest
```

#### Download from GITHUB release page

You can also get `kpm` from the github release and set the `kpm` binary path to the environment variable PATH.

```shell
# KPM_INSTALLATION_PATH is the path of the `kpm` binary.
export PATH=$KPM_INSTALLATION_PATH:$PATH  
```

Use the following command to ensure that you install `kpm` successfully.

```shell
kpm --help
```

If you get the following output, you have successfully installed `kpm` and you can proceed to the following steps.

<img src="./docs/gifs/kpm_help.gif" width="600" align="center" />

## Quick Start

### Init an empty kcl package

First, create an empty folder for the KCL package and go into that folder.

```shell
mkdir my_package # create an empty folder 'my_package'
cd my_package # go into the folder 'my_package'
```

Create a new kcl package named `my_package`.

```shell
kpm init my_package
```

<img src="./docs/gifs/kpm_init.gif" width="600" align="center" />

`kpm` will create two kcl package configuration files: `kcl.mod` and `kcl.mod.lock` in the directory where you executed the command.

```shell
- my_package
      |- kcl.mod
      |- kcl.mod.lock
      |- # You can write your kcl program directly in this directory.
```

`kcl.mod.lock` is the file generated by `kpm` to fix the dependency version. Do not modify this file manually.

`kpm` initializes `kcl.mod` for an empty project as shown below:

```shell
[package]
name = "my_package"
edition = "0.0.1"
version = "0.0.1"
```

### Add a dependency from Git Registry

If you need to use the KCL model in [Konfig](https://github.com/awesome-kusion/konfig.git) to write the kcl program.

```shell
kpm add -git https://github.com/awesome-kusion/konfig.git -tag v0.0.1
```

<img src="./docs/gifs/kpm_add_git.gif" width="600" align="center" />

You can see that `kpm` adds the dependency you just added to kcl.mod.

```shell
[package]
name = "my_package"
edition = "0.0.1"
version = "0.0.1"

[dependencies]
# 'konfig' is the package name
# If you want to use the contents of this package, 
# you need to write the import statment with the package name 'konfig' as the prefix.
konfig = { git = "https://github.com/awesome-kusion/konfig.git", tag = "v0.0.1" }
```

### Write a kcl program that uses the content in `konfig`

Create the `main.k` file in the current package.

```shell
- my_package
      |- kcl.mod
      |- kcl.mod.lock
      |- main.k # Your KCL program.
```

And write the following into the `main.k` file.

```kcl
import konfig.base.examples.native.nginx_deployment as nd

demo = nd.demo
```

### Use the `kpm` compile the kcl package

In the `my_package` directory, you can use `kpm` to compile the `main.k` file you just wrote.

```shell
kpm run
```

<img src="./docs/gifs/kpm_run.gif" width="600" align="center" />

If you want to use some kcl compilation options, you can pass the arguments to  through the `--kcl_args` provided by kpm.  

As shown below, you can pass the arguments `-S demo` to ignore the `demo` in the output result.

```shell
kpm run --kcl_args '-S demo'
```

<img src="./docs/gifs/kpm_run_with_args.gif" width="600" align="center" />

### Package your current kcl package with its dependencies

You can use the command `kpm pkg` to package your current kcl package with its dependencies.

```shell
kpm pkg --target my_package_tar
```

<img src="./docs/gifs/kpm_pkg.gif" width="600" align="center" />

After this command is executed, a tar package will be packaged in the `my_package_tar` directory. And all the dependencies for `my_package` will be stored in the `vendor` subdirectory.

```shell
- my_package
      |- kcl.mod
      |- kcl.mod.lock
      |- main.k
      |- my_package_tar 
            |- my_package-v0.0.1.tar # The file (*.tar) packaged by kpm.
      |- vendor # All the dependencies for `my_package` will be stored in the `vendor` 
            |- konfig_v0.0.1
```

## Supports OCI Registry

Beginning in kpm v0.2.0, you can use container registries with OCI support to store and share kcl packages.

For more information about [OCI registry support](./docs/kpm_oci.md).
